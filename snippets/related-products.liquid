{% assign related_product_title = "Also Available In" %}
{% assign related_image_size = 'large' %}

{% for tag in product.tags %}
{% if tag contains 'related-products' %}
  {% assign related_product_tag_handle = tag | handle %}
{% endif %}
{% endfor %}

{% if related_product_tag_handle %}
<section class="also-available">
  <h2>{{ related_product_title }}</h2>

{% assign current_related_product = product %}
{% assign current_related_product_found = false %}

<ul>
  {% for product in collections.[related_product_tag_handle].products %}
  {% if product.handle == current_related_product.handle %}
  {% assign current_related_product_found = true %}
  {% else %}
  {% unless current_related_product_found == false and forloop.last %}
  <li itemscope itemtype="http://schema.org/Product">
    <div class="image">
      <a href="{{ product.url | within: product_collection }}" title="{{ product.title | escape }}">
        {{ product.featured_image | product_img_url: related_image_size | img_tag }}
      </a>
    </div>
    <h3 itemprop="name"><a href="{{ product.url }}" title="{{ product.title | escape }}">{{ product.title }}</a></h3>
  </li>
  {% endunless %}
  {% endif %}
  {% endfor %}
</ul>
</section>
{% endif %}
